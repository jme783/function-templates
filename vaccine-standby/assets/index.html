<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get started with your Twilio Functions!</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/milligram/dist/milligram.min.css">
    <style>
      body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 1024px;
        margin: 0 auto;
      }

      div[role="main"] {
        flex: 1;
      }

      footer {
        text-align: center;
      }

      footer p {
        margin-bottom: 0;
      }

      #twilio-logo {
        width: 50px;
        height: 50px;
      }
      .btn {
        background-color: #0263e0;
        transition: all .2s cubic-bezier(.4,0,.2,1);
        box-shadow: 0 5px 30px rgb(17 17 17 / 30%);
        color: hsla(0,0%,100%,.8);
        padding: 8px 15px;
        font-size: 22px;
        font-weight: 100px;
        border-radius: 4px;
        line-height: 1.7;
      }
      .btn:hover {
        color: white;
        background: rgb(3, 11, 93);
        cursor: pointer;
      }
      .deploy-studio-flow {
        margin: 10px 0;
        margin-bottom: 30px;
      }
      .standby-list-diagram {
        border: 1px solid rgb(136, 145, 170);
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>COVID-19 Vaccine Standby List</h1>
      <img class="standby-list-diagram" src="/standby-list-diagram.png" />
      <p>This Quick Deploy app is designed for public health agencies to create a COVID-19 vaccine eligibility standby list for their city or state.
      Residents send an SMS to a pre-configured phone number, and are asked a series of demographic questions informed by the CDC's vaccine rollout guidelines powered by a Twilio Studio Flow.
       
      <p>This data is meant to help ensure vaccinations are administered as quickly as possible as supply becomes available. With this template, your agency can create a standardized list of eligible
      vaccine recipients. In exchange for sharing this information, residents are notified when it is their turn to receive the vaccine.</p>
    </header>
    <div role="main">
      <section>
        <div id="deploy-flow" style="display: none;" class="deploy-studio-flow">
          <h3>Finish configuring your app</h3>
          <p>Your app is deployed, but you need to finish configuring it to get it working. Click the button below to automatically run the following deployment steps:</p>
          <ul>
            <li>Deploy Studio Flow</li>
            <li>Link Studio Flow data capture to Airtable</li>
            <li>Configure phone number with a Studio flow</li>
          </ul>
          <a class="btn" onclick="setup(event)">Deploy Vaccine Standby List</a>
        </div>
        <div id="flow-deployed" style="display: none;" class="deploy-studio-flow">
          <h3>Your App is Deployed</h3>
          <a id="open-studio" class="btn" href="" target="_blank">Open Vaccine Standby List Studio Flow</a>
        </div>
      </section>
      <section>
        <h3>Test your Standby List</h3>
        <p>Once you deploy your Studio Flow successfully, you can try out your Standby List by sending a text message to <strong id="phone-number"></strong>.</p>
        <p>When you finish going through the chatbot, you should see your record recorded below:</p>
        <div id="residents-table">
          <table>
            <thead>
              <th>Name</th>
              <th>Phone Number</th>
              <th>Age</th>
              <th>Zip Code</th>
              <th>Essential Worker</th>
              <th>Work from Home</th>
              <th>Long Term Care</th>
              <th>Congregate Setting</th>
              <th>Health Condition</th>
              <th>Notification Preference</th>
              <th>Language Preference</th>
            </thead>
            <tbody id="residents-table-body">
            </tbody>
          </table>
        </div>
      </section>
    </div>
    <footer>
      <p>
        <a href="https://www.twilio.com/">
          <svg id="twilio-logo" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 60 60">
            <defs>
              <style>
                .cls-1 {
                  fill: #f22f46;
                }
              </style>
            </defs>
            <title>Twilio Logo</title><path class="cls-1" d="M30,15A15,15,0,1,0,45,30,15,15,0,0,0,30,15Zm0,26A11,11,0,1,1,41,30,11,11,0,0,1,30,41Zm6.8-14.7a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,26.3Zm0,7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,33.7Zm-7.4,0a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,33.7Zm0-7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,26.3Z"/></svg>
        </a>
      </p>
      <p>
        <a href="https://www.twilio.com/code-exchange">Learn about other things you can build with Twilio</a>
      </p>
    </footer>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script>
      // This code will replace the content of any <span class="function-root"></span> with the base path of the URL
      const baseUrl = new URL(location.href);
      baseUrl.pathname = baseUrl
        .pathname
        .replace(/\/index\.html$/, '');
      delete baseUrl.hash;
      delete baseUrl.search;
      const fullUrl = baseUrl
        .href
        .substr(0, baseUrl.href.length - 1);
      const functionRoots = document.querySelectorAll('span.function-root');

      functionRoots.forEach(element => {
        element.innerText = fullUrl
      })
      let request = new XMLHttpRequest();
      request.open('GET', fullUrl + '/return-config');
      request.send();
      request.onload = () => {
        const response = JSON.parse(request.response);
        const phone_number = response.phone_number;

        // Grab the phone number being used and display it to help the user test their app
        const phone_number_element = document.getElementById('phone-number');
        phone_number_element.innerHTML = phone_number;
      }

      function setup(e) {
        e.preventDefault();

        fetch('/setup').then(response => {
          checkStudioFlow();
        })
        .catch(err => console.log("An error ocurred", err));
      }

      function checkStudioFlow() {
        fetch('/check-existing-flow')
          .then(response => response.text())
          .then(sid => {
            if (sid === 'none') {
              $('#deploy-flow').show();
              console.log('no flow')
            } else {
              $('#flow-deployed').show();
              $('#deploy-flow').hide();
              $('#open-studio').attr('href', `https://www.twilio.com/console/studio/flows/${sid}`)
              console.log('flow exists');
              getStudioExecutions(sid);
              setInterval(getStudioExecutions, 3000, sid);
            }
          });
      };

      function getStudioExecutions(sid) {
        console.log('Pulling from Studio...');
        const tbody = $('#residents-table-body');
        fetch(`/get-studio-executions?sid=${sid}`)
          .then(response => response.json())
          .then(data => {
            let rows = "";
            for (var i = 0; i < data.length; i++) {
              let tr = "<tr>";
              tr += "<td>"+data[i].name+"</td>";
              tr += "<td>"+data[i].phone_number+"</td>";
              tr += "<td>"+data[i].age+"</td>";
              tr += "<td>"+data[i].zip_code+"</td>";
              tr += "<td>"+data[i].essential_worker+"</td>";
              tr += "<td>"+data[i].work_from_home+"</td>";
              tr += "<td>"+data[i].long_term_care+"</td>";
              tr += "<td>"+data[i].congregate_setting+"</td>";
              tr += "<td>"+data[i].health_condition+"</td>";
              tr += "<td>"+data[i].notification_preference+"</td>";
              tr += "<td>"+data[i].language_preference+"</td>";
              tr += "</tr>";

              rows = rows.concat(tr);
            }
            tbody.html(rows);
          })
          .catch(err => console.log(err));
      }

      checkStudioFlow();
    </script>
  </body>
</html>
