<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get started with your Twilio Functions!</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/milligram/dist/milligram.min.css">
    <style>
      body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 1024px;
        margin: 0 auto;
      }

      div[role="main"] {
        flex: 1;
      }

      footer {
        text-align: center;
      }

      footer p {
        margin-bottom: 0;
      }

      #twilio-logo {
        width: 50px;
        height: 50px;
      }
      .btn {
        background-color: #0263e0;
        transition: all .2s cubic-bezier(.4,0,.2,1);
        box-shadow: 0 5px 30px rgb(17 17 17 / 30%);
        color: hsla(0,0%,100%,.8);
        padding: 8px 15px;
        font-size: 22px;
        font-weight: 100px;
        border-radius: 4px;
        line-height: 1.7;
        display: inline-block;
      }
      .btn.secondary {
        background-color: white;
        border: 1px solid #0263e0;
        color: #0263e0;
        box-shadow: none;
      }
      .btn.secondary:hover {
        background-color: white;
        border: 1px solid rgb(3, 11, 93);
        color: rgb(3, 11, 93);
      }
      .btn:hover {
        color: white;
        background: rgb(3, 11, 93);
        cursor: pointer;
      }
      .btn.loading {
        background: rgb(244, 244, 246);
        color: rgb(96, 107, 133);
        box-shadow: none;
        cursor: default;
      }
      .loader {
        border: 4px solid rgb(244, 244, 246);
        border-top: 4px solid rgb(18, 28, 45);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-left: 5px;
        margin-top: -5px;
      }
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      .deploy-studio-flow {
        margin: 10px 0;
        margin-bottom: 30px;
      }
      .standby-list-diagram {
        border: 1px solid rgb(136, 145, 170);
        margin-bottom: 20px;
      }
      span.checkmark {
        color: rgb(20, 176, 83);
      }
      tr.table-placeholder {
        background: rgb(244, 244, 246);
        text-align: center;
      }
      tr.table-placeholder td {
        padding: 30px 0;
      }
      #test-standby-list {
        display: none;
      }

      #hipaa-disclaimer {
        border: 2px solid rgb(136, 145, 170);
        padding: 20px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>COVID-19 Vaccine Standby List</h1>
      <img class="standby-list-diagram" src="/standby-list-diagram.png" />
      <p>This Quick Deploy app is designed for public health agencies to create a COVID-19 vaccine eligibility standby list for their city or state.
      Residents send an SMS to a pre-configured phone number, and are asked a series of demographic questions informed by the CDC's vaccine rollout guidelines powered by a Twilio Studio Flow.
       
      <p>This data is meant to help ensure vaccinations are administered as quickly as possible as supply becomes available. With this template, your agency can create a standardized list of eligible
      vaccine recipients. In exchange for sharing this information, residents are notified when it is their turn to receive the vaccine.</p>
    </header>
    <div role="main">
      <section>
        <div id="deploy-flow" style="display: none;" class="deploy-studio-flow">
          <h3>Finish configuring your app</h3>
          <p>Your app is deployed, but you need to finish configuring it to get it working. Click the button below to automatically run the following deployment steps:</p>
          <ul>
            <li>Deploy Vaccine Standby List Studio Flow to power SMS chatbot</li>
            <li>Link your phone number (<strong class="phone-number"></strong>) with Studio Flow</li>
          </ul>
          <a class="btn" onclick="setup(event)">Deploy Studio Flow</a>
          <div class="loader" style="display: none;"></div>
        </div>
        <div id="flow-deployed" style="display: none;" class="deploy-studio-flow">
          <h3><span class="checkmark">&#10003;</span> Your Studio Flow is deployed</h3>
          <p>You can move on to test your vaccine standby list below or click the button to make changes to your Studio Flow.</p>
          <a id="open-studio" class="btn secondary" href="" target="_blank">Edit Studio Flow</a>
        </div>
      </section>
      <section>
        <h3>Password required</h1>
        <p>
          A password is required to update your environment. This can be found in the <code>.env</code>file in the root of your application. 
        </p>
        <form>
          <div>
            <label for="password">Password:
              <input id="password-input" type="password" name="password">
            </label>
          </div>
          <button class="btn secondary" onclick="login(event)">Login</button>
        </form>
      </section>
      <section id="test-standby-list">
        <h3>Test your Standby List</h3>
        <p>You can try out your Standby List by sending a text message to <strong class="phone-number"></strong>. If your account is in trial mode, you will need to send the SMS from <a href="https://www.twilio.com/docs/usage/tutorials/how-to-use-your-free-trial-account#verify-your-personal-phone-number" target="_blank">verified phone numbers</a>.</p>
        <p>As the chatbot is completed, you should see records recorded below, pulled from <a class="execution-logs-link" href="" target="_blank">Studio Flow execution</a> logs:</p>
        <div id="hipaa-disclaimer">
          Note that organizations which are covered entities and subject to HIPAA should <a href="https://ahoy.twilio.com/vaccine-distribution-1" target="_blank">consult with a Twilio Expert</a> before publicly offering this service in a production context. Business Associate Addendums (BAA) are available from Twilio for the offerings shown in this solution.
        </div>
        <div id="residents-table">
          <table>
            <thead>
              <th>Name</th>
              <th>Phone Number</th>
              <th>Age</th>
              <th>Zip Code</th>
              <th>Essential Worker</th>
              <th>Work from Home</th>
              <th>Long Term Care</th>
              <th>Congregate Setting</th>
              <th>Health Condition</th>
              <th>Notification Preference</th>
              <th>Language Preference</th>
            </thead>
            <tbody id="residents-table-body">
              <tr class="table-placeholder"><td colspan="11">No records yet. Send a text message to <strong class="phone-number"></strong> to begin.</td></tr>
            </tbody>
          </table>
        </div>
      </section>
      <section>
        <h3>Next Steps</h3>
        <p>Getting the world vaccinated is no small feat. We're here to help. <strong><a href="https://ahoy.twilio.com/vaccine-distribution-1" target="_blank">Get in touch</a></strong> if you would like support with any of the following on the path to a production deployment:</p>
        <ul>
          <li>Persisting this data into a database</li>
          <li>Adding other channels for registering for vaccine notifications like Voice, WhatsApp, and Web Chat</li>
          <li>Getting a Business Associate Addendums (BAA) in place with Twilio for HIPAA compliance</li>
          <li>Accessing implementation support from Twilio's trusted partners</li>
        </ul>
      </section>
      <section>
        <h3>Troubleshooting</h3>
        <ul>
          <strong>If you aren't getting a response when texting your phone number, make sure that:</strong>
          <li>If your account is in trial mode, you are sending the SMS from <a href="https://www.twilio.com/docs/usage/tutorials/how-to-use-your-free-trial-account#verify-your-personal-phone-number" target="_blank">verified phone numbers</a>.</li>
          <li>Your Twilio phone number's (<a href="https://www.twilio.com/console/phone-numbers/incoming" target="_blank"><span class="phone-number"></span></a>) Message Configuration is set to the "Vaccine Standby Intake" Studio Workflow.</li>
        </ul>
        <ul>
          <strong>If you aren't seeing responses show up in the table above, make sure that:</strong>
          <li>The texter has fully completed the chatbot interaction. Responses are not added until the end (e.g. "You are now on the vaccine standby list").</li>
          <li>You see the execution logged <a class="execution-logs-link" href="" target="_blank">here</a> and the status of the execution is set to <code>ended</code>.</li>
        </ul>
      </section>
    </div>
    <footer>
      <p>
        <a href="https://www.twilio.com/">
          <svg id="twilio-logo" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 60 60">
            <defs>
              <style>
                .cls-1 {
                  fill: #f22f46;
                }
              </style>
            </defs>
            <title>Twilio Logo</title><path class="cls-1" d="M30,15A15,15,0,1,0,45,30,15,15,0,0,0,30,15Zm0,26A11,11,0,1,1,41,30,11,11,0,0,1,30,41Zm6.8-14.7a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,26.3Zm0,7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,33.7Zm-7.4,0a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,33.7Zm0-7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,26.3Z"/></svg>
        </a>
      </p>
      <p>
        <small style="display: block;">Made with <3 by the Twilio.org team</small>
        <a href="https://www.twilio.com/code-exchange">Learn about other things you can build with Twilio</a>
      </p>
    </footer>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script>
      let phone_number;
      let accessToken;
      let flowSid;

      // This code will replace the content of any <span class="function-root"></span> with the base path of the URL
      const baseUrl = new URL(location.href);
      baseUrl.pathname = baseUrl
        .pathname
        .replace(/\/index\.html$/, '');
      delete baseUrl.hash;
      delete baseUrl.search;
      const fullUrl = baseUrl
        .href
        .substr(0, baseUrl.href.length - 1);
      const functionRoots = document.querySelectorAll('span.function-root');

      functionRoots.forEach(element => {
        element.innerText = fullUrl
      })
      let request = new XMLHttpRequest();
      request.open('GET', fullUrl + '/return-config');
      request.send();
      request.onload = () => {
        const response = JSON.parse(request.response);
        phone_number = response.phone_number;

        // Grab the phone number being used and display it to help the user test their app
        const phone_number_elements = $('.phone-number');
        phone_number_elements.html(phone_number);
      }

      function setup(e) {
        e.preventDefault();
        $('#deploy-flow .btn').addClass('loading');
        $('.loader').show();

        fetch('/setup').then(response => {
          checkStudioFlow();
        })
        .catch(err => {
          console.log("An error ocurred creating Studio Flow", err);
          $('#deploy-flow .btn').removeClass('loading');
          $('.loader').hide();
        });
      }

      function checkStudioFlow() {
        fetch('/check-existing-flow')
          .then(response => response.text())
          .then(sid => {
            $('#deploy-flow .btn').removeClass('loading');
            $('.loader').hide();
            if (sid === 'none') {
              $('#deploy-flow').show();
              console.log('no flow')
            } else {
              flowSid = sid;
              $('#flow-deployed').show();
              $('#deploy-flow').hide();
              $('#open-studio').attr('href', `https://www.twilio.com/console/studio/flows/${sid}`);
              $('.execution-logs-link').attr('href', `https://www.twilio.com/console/studio/flows/${sid}/executions`);
              console.log('flow exists');
            }
          });
      };

      function getStudioData(token) {
          $('#test-standby-list').show();
          clearInterval(getStudioExecutions);
          setInterval(getStudioExecutions, 3000, flowSid, token);
      }

      async function login(e) {
        e.preventDefault();

        let passwordInput = $('#password-input').val();
        console.log(passwordInput);
        const response = await fetch('/login', {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({'password': passwordInput})
        })
        .then(response => response.json())
        .then(t => {
          console.log('response');
          console.log(t);
          debugger;
          getStudioData(t.token);
        })
        .catch(err => console.log(err));
      }

      function getStudioExecutions(sid, token) {
        console.log('Pulling from Studio...');
        const tbody = $('#residents-table-body');
        fetch(`/get-studio-executions?sid=${sid}&token=${token}`)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              let rows = "";
              for (var i = 0; i < data.length; i++) {
                if(data[i]) {
                  let tr = "<tr>";
                  tr += "<td>"+data[i].name+"</td>";
                  tr += "<td>"+data[i].phone_number+"</td>";
                  tr += "<td>"+data[i].age+"</td>";
                  tr += "<td>"+data[i].zip_code+"</td>";
                  tr += "<td>"+data[i].essential_worker+"</td>";
                  tr += "<td>"+data[i].work_from_home+"</td>";
                  tr += "<td>"+data[i].long_term_care+"</td>";
                  tr += "<td>"+data[i].congregate_setting+"</td>";
                  tr += "<td>"+data[i].health_condition+"</td>";
                  tr += "<td>"+data[i].notification_preference+"</td>";
                  tr += "<td>"+data[i].language_preference+"</td>";
                  tr += "</tr>";

                  rows = rows.concat(tr);
                }
              }
              tbody.html(rows);
            } else {
              tbody.html(`<tr class="table-placeholder"><td colspan="11">No records yet. Send a text message to <strong class="phone-number">${phone_number}</strong> to begin.</td></tr>`)
            }
          })
          .catch(err => console.log(err));
      }

      checkStudioFlow();
    </script>
  </body>
</html>
